<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タップで方位表示</title>
    <style>
      #map {
        width: 100%;
        height: 100vh;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div id="info">タップすると方位を表示します</div>
    <div id="map"></div>

    <script>
      let map, userPos;

      // 角度計算（現在地 → タップ地点）
      function calcBearing(lat1, lon1, lat2, lon2) {
        const toRad = deg => deg * Math.PI / 180;
        const toDeg = rad => rad * 180 / Math.PI;

        const dLon = toRad(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRad(lat2));
        const x =
          Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
          Math.sin(toRad(lat1)) *
            Math.cos(toRad(lat2)) * Math.cos(dLon);

        let brng = toDeg(Math.atan2(y, x));
        return (brng + 360) % 360; // 0〜360°
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: { lat: 26.33, lng: 127.85 },
        });

        // 現在地取得
        navigator.geolocation.getCurrentPosition(pos => {
          userPos = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };
          map.setCenter(userPos);
        });

        let marker = null;

        map.addListener("click", (e) => {
          if (!userPos) return;

          if (marker) marker.setMap(null);

          marker = new google.maps.Marker({
            position: e.latLng,
            map: map,
          });

          const bearing = calcBearing(
            userPos.lat, userPos.lng,
            e.latLng.lat(), e.latLng.lng()
          );

          document.getElementById("info").innerHTML =
            `方位：${bearing.toFixed(1)}°`;
        });
      }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async></script>
  </body>
</html>
