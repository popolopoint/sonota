<!DOCTYPE html>
<html>
<head>
    <title>Google Maps 方位計算</title>
    <style>
        /* 地図コンテナのスタイル */
        #map {
            height: 400px;
            width: 100%;
        }
        /* 結果表示エリアのスタイル */
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="result">
        <p>1点目（A点）と2点目（B点）をマップ上でクリック（タップ）してください。</p>
        <p>A点から見たB点の方位がここに表示されます。</p>
        <p>現在のクリック回数: <span id="clickCount">0</span>回</p>
    </div>

    <script>
        // Google Maps APIキーを設定
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        // 座標を保持する配列
        let selectedPoints = []; 
        let map;

        /**
         * マップを初期化する
         */
        function initMap() {
            // 初期表示の中心座標
            const initialCenter = { lat: 35.6895, lng: 139.6917 }; // 例：東京

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: initialCenter,
            });

            // クリックイベントリスナーを設定
            map.addListener('click', handleMapClick);
        }

        /**
         * マップがクリックされたときの処理
         * @param {google.maps.MapMouseEvent} event 
         */
        function handleMapClick(event) {
            const latLng = event.latLng;
            selectedPoints.push(latLng);

            // 1点目(A点)と2点目(B点)のマーカーを設置
            new google.maps.Marker({
                position: latLng,
                map: map,
                label: selectedPoints.length === 1 ? 'A' : 'B',
            });

            // クリック回数を更新
            document.getElementById('clickCount').textContent = selectedPoints.length;

            if (selectedPoints.length === 2) {
                // 2点揃ったら方位を計算し表示
                calculateAndDisplayBearing();

                // 線の描画（オプション）
                new google.maps.Polyline({
                    path: selectedPoints,
                    geodesic: true, // 球面上の最短距離
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map,
                });
                
                // 次の操作のためにリセット
                selectedPoints = []; 

                // マーカーや線を消したい場合は、それらを配列で保持し、map: null に設定する処理を追加してください。

            } else if (selectedPoints.length > 2) {
                // 2点以上になったらリセット
                selectedPoints = [];
                // マップを再初期化（リフレッシュ）
                initMap();
                handleMapClick(event); // 現在のクリックを1点目として再処理
            }
        }

        /**
         * 2点間の球面上の初期方位（Bearing）を計算する
         * 方位（Bearing）は北を0°として時計回りに測った角度です。
         */
        function calculateBearing(startLat, startLng, endLat, endLng) {
            // 度をラジアンに変換
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            // 方位角の計算式
            // y = sin(Δλ) * cos(φ2)
            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            // x = cos(φ1) * sin(φ2) - sin(φ1) * cos(φ2) * cos(Δλ)
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            // アークタンジェント2（atan2）で方位角（ラジアン）を計算
            let bearingRad = Math.atan2(y, x);

            // ラジアンを度に変換
            let bearingDeg = bearingRad * (180 / Math.PI);

            // 結果を0°〜360°の範囲に正規化 (北を0°、東を90°、南を180°、西を270°)
            return (bearingDeg + 360) % 360;
        }


        /**
         * 方位を計算し、結果エリアに表示する
         */
        function calculateAndDisplayBearing() {
            if (selectedPoints.length < 2) return;

            const startPoint = selectedPoints[0]; // A点
            const endPoint = selectedPoints[1];   // B点

            const bearing = calculateBearing(
                startPoint.lat(), startPoint.lng(),
                endPoint.lat(), endPoint.lng()
            );

            // 結果を整形して表示
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>✅ 結果</h3>
                <p><strong>A点</strong> (出発点): ${startPoint.lat().toFixed(4)}, ${startPoint.lng().toFixed(4)}</p>
                <p><strong>B点</strong> (終点): ${endPoint.lat().toFixed(4)}, ${endPoint.lng().toFixed(4)}</p>
                <p>
                    <strong>A点から見たB点の方位 (Bearing): 
                    <span style="font-size: 1.2em; color: #007bff;">${bearing.toFixed(2)}°</span>
                    </strong>
                </p>
                <p>（北を0°として時計回りの角度）</p>
                <p style="margin-top: 10px; color: red;">**リセットされました。次のA点/B点をクリックしてください。**</p>
            `;
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>