<!DOCTYPE html>
<html>
<head>
    <title>360map2.5e - æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼é€£å‹•</title>
    <style>
        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 70vh; /* ã‚»ãƒ³ã‚µãƒ¼çª“ã®ãŸã‚ã«é«˜ã•ã‚’èª¿æ•´ */
            width: 100%;
        }
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #result {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e9f5ff;
            border-radius: 5px;
        }
        #result h3 {
            color: #007bff;
        }
        /* ã‚»ãƒ³ã‚µãƒ¼çª“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #compassWindow {
            padding: 15px;
            margin-top: 10px;
            border: 2px solid #ff9900;
            background-color: #fff8e1;
            border-radius: 5px;
            text-align: center;
        }
        #compassWindow strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #ff9900;
        }
        #headingDisplay {
            font-size: 2.5em;
            color: #d9534f; /* èµ¤ç³» */
            font-weight: bold;
        }
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #setLocationButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        #startCompassButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #ff9900; /* ã‚»ãƒ³ã‚µãƒ¼ç”¨ãƒœã‚¿ãƒ³ã®è‰² */
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼é€£å‹•è¨ˆç®— (360map2.5e)</h1>

    <button id="setLocationButton">ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š</button>
    
    <div id="bPointSelection">
        <strong>Bç‚¹ (ç›®çš„åœ°) ã®é¸æŠ:</strong>
        <label><input type="radio" name="b_option" value="gushikawa" checked> å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="kinjo"> é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="tap"> åœ°å›³ä¸Šã§ã‚¿ãƒƒãƒ—</label>
    </div>
    <p id="bTapInstruction" style="display:none; color: red; font-weight: bold;">**åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„**</p>

    <div id="result">
        <p class="initial-prompt">ã¾ãšAç‚¹ã¨Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <button id="startCompassButton" disabled>Bç‚¹ã«ã‚¹ãƒãƒ›ã‚’å‘ã‘ã‚‹ (ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹)</button>
    <div id="compassWindow">
        <strong>ğŸ§­ Bç‚¹ã¸ã®æ–¹å‘</strong>
        <p id="headingDisplay">--</p>
        <p style="font-size: 0.9em;" id="compassStatus">Aç‚¹ã¨Bç‚¹ãŒè¨­å®šã•ã‚Œã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
    </div>

    <div id="map"></div>

    <script>
        // Google Maps APIã‚­ãƒ¼ã‚’è¨­å®š
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        const B_POINTS = {
            gushikawa: { lat: 26.3803176, lng: 127.8751869, name: "å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" },
            kinjo: { lat: 26.4454055, lng: 127.9209787, name: "é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" }
            // è¿½åŠ ã—ãŸã„Bç‚¹ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„
        };
        
        let map;
        let currentOriginA = null;
        let currentDestinationB = null;
        let mapTapMode = false;
        
        let markerA = null;
        let markerB = null;
        let polyline = null;

        let targetBearing = null; // Aç‚¹ã‹ã‚‰Bç‚¹ã¸ã®ç›®æ¨™æ–¹ä½ (è¨ˆç®—çµæœ)


        /**
         * ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹
         */
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: B_POINTS.gushikawa,
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            document.getElementById('setLocationButton').addEventListener('click', findCurrentLocation);
            document.getElementById('startCompassButton').addEventListener('click', initCompass);
            
            document.getElementsByName('b_option').forEach(radio => {
                radio.addEventListener('change', handleBSelectionChange);
            });
            map.addListener('click', handleMapClick);

            // åˆæœŸBç‚¹ã‚’è¨­å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…·å¿—å·)
            setDestinationB(B_POINTS.gushikawa);
            updateCompassButtonStatus();
        }
        
        // --- ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ã®é–¢æ•° ---

        /**
         * ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
         */
        function initCompass() {
            const statusDiv = document.getElementById('compassStatus');
            
            if (!targetBearing) {
                statusDiv.textContent = 'è¨ˆç®—ãŒå¿…è¦ã§ã™ã€‚Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            // iOS 13+ ã®æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (æ¨™æº–åŒ–ã•ã‚ŒãŸå½¢å¼ã§ã¯ãªã„ãŒã€å¤šãã®iOSãƒ‡ãƒã‚¤ã‚¹ã§å¿…è¦)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ã€‚ç«¯æœ«ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚';
                        } else {
                            statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        }
                    })
                    .catch(console.error);
            } else {
                // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ (Android/å¤ã„iOSãªã©)
                window.addEventListener('deviceorientation', handleOrientation);
                statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ã€‚ç«¯æœ«ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚';
            }
            
            document.getElementById('startCompassButton').disabled = true;
        }

        /**
         * ãƒ‡ãƒã‚¤ã‚¹ã®å‘ããŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®å‡¦ç†
         * @param {DeviceOrientationEvent} event 
         */
        function handleOrientation(event) {
            if (event.alpha === null || targetBearing === null) return;

            // ã‚³ãƒ³ãƒ‘ã‚¹æ–¹ä½ã‚’å–å¾— (åŒ—ã‚’0åº¦ã€æ™‚è¨ˆå›ã‚Š)
            // Webæ¨™æº–ã§ã¯ Alpha ã¯ç£åŒ—ã‹ã‚‰ã®è§’åº¦ (0-360) ã‚’ç¤ºã™ã€‚
            // ç«¯æœ«ã®å‘ãã¨ã‚³ãƒ³ãƒ‘ã‚¹ã®å·®ã‚’è€ƒæ…®ã™ã‚‹ãŸã‚ã€360ã‹ã‚‰å¼•ãã“ã¨ãŒå¤šã„ãŒã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
            let currentHeading = 360 - event.alpha; // ç£åŒ—ã‚’åŸºæº–ã¨ã—ãŸæ–¹ä½

            // ç›®çš„åœ°ã¸ã®ç›®æ¨™æ–¹ä½ã¨ç¾åœ¨ã®é€²è¡Œæ–¹å‘ã®å·®ã‚’è¨ˆç®—
            // ç›®æ¨™ (targetBearing) - ç¾åœ¨ã®æ–¹å‘ (currentHeading)
            let diff = targetBearing - currentHeading;

            // å·®ã‚’ -180åº¦ã‹ã‚‰ +180åº¦ã®é–“ã«æ­£è¦åŒ–
            if (diff > 180) {
                diff -= 360;
            } else if (diff < -180) {
                diff += 360;
            }

            const display = document.getElementById('headingDisplay');
            
            if (Math.abs(diff) < 5) {
                display.innerHTML = `âœ… ${targetBearing.toFixed(1)}Â° <br> **æ–¹å‘ãŒåˆã£ã¦ã„ã¾ã™**`;
                display.style.color = '#28a745'; // ç·‘
            } else {
                let turnDirection = diff > 0 ? 'å³' : 'å·¦';
                display.innerHTML = `ç›®æ¨™: ${targetBearing.toFixed(1)}Â° <br> ${turnDirection}ã«${Math.abs(diff).toFixed(1)}Â°å‘ã‘ç›´ã—ã¦ãã ã•ã„`;
                display.style.color = '#d9534f'; // èµ¤
            }
        }
        
        /**
         * Bç‚¹é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®å‡¦ç†
         */
        function handleBSelectionChange(event) {
            // ... (å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® Bç‚¹é¸æŠãƒ­ã‚¸ãƒƒã‚¯ ... å¤‰æ›´ãªã—) ...
            const selectedValue = event.target.value;
            document.getElementById('bTapInstruction').style.display = 'none';
            mapTapMode = false;
            
            if (selectedValue === 'tap') {
                document.getElementById('bTapInstruction').style.display = 'block';
                currentDestinationB = null;
                mapTapMode = true;
            } else {
                setDestinationB(B_POINTS[selectedValue]);
            }
            
            if (currentOriginA) {
                calculateAndDisplay();
            }
            updateCompassButtonStatus();
        }

        /**
         * ãƒãƒƒãƒ—ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
         */
        function handleMapClick(event) {
            if (mapTapMode) {
                setDestinationB({
                    lat: event.latLng.lat(), 
                    lng: event.latLng.lng(), 
                    name: "ãƒãƒƒãƒ—ã‚¿ãƒƒãƒ—ä½ç½® (Bç‚¹)"
                });
                
                mapTapMode = false;
                document.getElementById('bTapInstruction').style.display = 'none';
                document.querySelector('input[name="b_option"][value="tap"]').checked = true;

                if (currentOriginA) {
                    calculateAndDisplay();
                }
                updateCompassButtonStatus();
            }
        }
        
        /**
         * Bç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­å®šã—ã€è¨ˆç®—ã‚’è©¦ã¿ã‚‹
         */
        function setDestinationB(coords) {
            currentDestinationB = new google.maps.LatLng(coords.lat, coords.lng);
            
            if (markerB) {
                markerB.setPosition(currentDestinationB);
                markerB.setTitle(coords.name);
            } else {
                markerB = new google.maps.Marker({
                    position: currentDestinationB,
                    map: map,
                    title: coords.name,
                    label: 'B',
                });
            }
            
            if (currentOriginA) {
                calculateAndDisplay();
            } else {
                map.setCenter(currentDestinationB);
            }
        }
        

        /**
         * ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹ (Aç‚¹è¨­å®š)
         */
        function findCurrentLocation() {
            document.getElementById('result').innerHTML = '<p class="loading">ç¾åœ¨åœ°ã‚’æ¤œå‡ºä¸­ã§ã™...</p>';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentLat = position.coords.latitude;
                        const currentLng = position.coords.longitude;
                        currentOriginA = new google.maps.LatLng(currentLat, currentLng);
                        
                        if (markerA) {
                            markerA.setPosition(currentOriginA);
                        } else {
                            markerA = new google.maps.Marker({
                                position: currentOriginA,
                                map: map,
                                title: "ç¾åœ¨ä½ç½® (Aç‚¹)",
                                label: 'A',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#007bff',
                                    fillOpacity: 1,
                                    strokeWeight: 0,
                                }
                            });
                        }
                        
                        calculateAndDisplay();
                        document.getElementById('setLocationButton').textContent = 'ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š (æ›´æ–°)';
                        updateCompassButtonStatus();

                    },
                    (error) => {
                        handleLocationError(true);
                        console.error("Geolocation failed:", error);
                    }
                );
            } else {
                handleLocationError(false);
            }
        }

        /**
         * 2ç‚¹é–“ã®çƒé¢ä¸Šã®åˆæœŸæ–¹ä½ï¼ˆBearingï¼‰ã‚’è¨ˆç®—ã™ã‚‹
         */
        function calculateBearing(startLat, startLng, endLat, endLng) {
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            let bearingRad = Math.atan2(y, x);
            let bearingDeg = bearingRad * (180 / Math.PI);

            return (bearingDeg + 360) % 360;
        }


        /**
         * Aç‚¹ã¨Bç‚¹ãŒæƒã£ã¦ã„ã‚‹å ´åˆã«ã€æ–¹ä½ã‚’è¨ˆç®—ã—ã€ãƒãƒ¼ã‚«ãƒ¼ã¨çµæœã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã™ã‚‹
         */
        function calculateAndDisplay() {
            if (!currentOriginA || !currentDestinationB) {
                document.getElementById('result').innerHTML = `<h3>å¾…æ©Ÿä¸­...</h3><p>Aç‚¹: ${currentOriginA ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}</p><p>Bç‚¹: ${currentDestinationB ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}</p>`;
                return;
            }
            
            const startLat = currentOriginA.lat();
            const startLng = currentOriginA.lng();
            const endLat = currentDestinationB.lat();
            const endLng = currentDestinationB.lng();

            targetBearing = calculateBearing(startLat, startLng, endLat, endLng); // â˜…â˜…â˜… ç›®æ¨™æ–¹ä½ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ â˜…â˜…â˜…

            // ç·šã®å†æç”»
            if (polyline) {
                polyline.setMap(null);
            }
            polyline = new google.maps.Polyline({
                path: [currentOriginA, currentDestinationB],
                geodesic: true, 
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map,
            });

            // åœ°å›³ã®è¡¨ç¤ºç¯„å›²ã‚’èª¿æ•´
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(currentOriginA);
            bounds.extend(currentDestinationB);
            map.fitBounds(bounds);


            // çµæœã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
            const resultDiv = document.getElementById('result');
            let bName = markerB ? markerB.getTitle() : 'ã‚¿ãƒƒãƒ—ä½ç½®';

            resultDiv.innerHTML = `
                <h3>âœ… æ–¹ä½è¨ˆç®—å®Œäº†</h3>
                <p><strong>Aç‚¹</strong> (ç¾åœ¨ä½ç½®): ${startLat.toFixed(4)}, ${startLng.toFixed(4)}</p>
                <p><strong>Bç‚¹</strong> (${bName}): ${endLat.toFixed(4)}, ${endLng.toFixed(4)}</p>
                <p>
                    <strong>Aç‚¹ã‹ã‚‰è¦‹ãŸBç‚¹ã®æ–¹ä½ (Bearing): 
                    <span style="font-size: 1.5em; color: #FF0000;">${targetBearing.toFixed(2)}Â°</span>
                    </strong>
                </p>
                <p>ï¼ˆåŒ—ã‚’0Â°ã¨ã—ã¦æ™‚è¨ˆå›ã‚Šã®è§’åº¦ï¼‰</p>
            `;
            updateCompassButtonStatus();
        }
        
        /**
         * ã‚»ãƒ³ã‚µãƒ¼ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°ã™ã‚‹
         */
        function updateCompassButtonStatus() {
            const button = document.getElementById('startCompassButton');
            const statusDiv = document.getElementById('compassStatus');
            
            if (currentOriginA && currentDestinationB) {
                button.disabled = false;
                statusDiv.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã«ã¯ã€ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else {
                button.disabled = true;
                statusDiv.textContent = 'Aç‚¹ã¨Bç‚¹ãŒè¨­å®šã•ã‚Œã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚';
            }
        }
        
        /**
         * ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
         */
        function handleLocationError(browserHasGeolocation) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>âŒ ç¾åœ¨ä½ç½®ã®å–å¾—ã«å¤±æ•— (Aç‚¹æœªè¨­å®š)</h3>
                <p style="color: red;">${browserHasGeolocation ? 
                    'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸã‹ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚' : 
                    'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚'
                }</p>
            `;
            updateCompassButtonStatus();
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>