<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>タップで360°方位表示</title>
    <style>
      #map { width: 100%; height: 100vh; }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 18px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body>
    <div id="info">方位: -</div>
    <div id="map"></div>

    <script>
      let map;
      let marker;

      function initMap() {
        // 初期位置：現在地に移動
        navigator.geolocation.getCurrentPosition((pos) => {
          const center = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };

          map = new google.maps.Map(document.getElementById("map"), {
            zoom: 17,
            center: center,
          });

          map.addListener("click", (e) => {
            showBearing(e.latLng);
          });
        });
      }

      // 現在地からタップ地点までの方位を計算（0〜360°）
      function showBearing(target) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat1 = pos.coords.latitude * Math.PI/180;
          const lon1 = pos.coords.longitude * Math.PI/180;
          const lat2 = target.lat() * Math.PI/180;
          const lon2 = target.lng() * Math.PI/180;

          const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
          const x = Math.cos(lat1)*Math.sin(lat2) -
                    Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2 - lon1);
          let brng = Math.atan2(y, x) * 180/Math.PI;
          if (brng < 0) brng += 360;

          document.getElementById("info").innerText = "方位: " + brng.toFixed(1) + "°";

          // マーカーも表示
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({
            position: target,
            map: map
          });
        });
      }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap"
    async defer></script>

  </body>
</html>
