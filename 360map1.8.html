<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>A→B 方位計算</title>
<style>
  #map { width:100%; height:100vh; }
  #bearing { 
    position:absolute; 
    top:10px; left:10px; 
    background:#fff; 
    padding:10px; 
    font-size:20px;
    border-radius:8px;
    box-shadow:0 0 5px #0003;
  }
</style>
</head>
<body>

<div id="bearing">A点を選択してください</div>
<div id="map"></div>

<script>
let map;
let A = null;
let B = null;
let markerA, markerB, line;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 26.33, lng: 127.85 },
    zoom: 13,
  });

  map.addListener("click", (e) => {
    if (!A) {
      A = e.latLng;
      markerA = new google.maps.Marker({
        position: A,
        map: map,
        label: "A"
      });
      document.getElementById("bearing").innerText = "B点を選択してください";
    } else if (!B) {
      B = e.latLng;
      markerB = new google.maps.Marker({
        position: B,
        map: map,
        label: "B"
      });

      // 線を引く
      line = new google.maps.Polyline({
        path: [A, B],
        map: map,
        strokeColor: "#ff0000"
      });

      // 方位計算
      const bearing = computeBearing(A.lat(), A.lng(), B.lat(), B.lng());
      document.getElementById("bearing").innerText =
        "A → B の方位: " + bearing.toFixed(1) + "°";
    }
  });
}

// A→B 方位計算
function computeBearing(lat1, lng1, lat2, lng2) {
  const rad = Math.PI / 180;
  const y = Math.sin((lng2 - lng1) * rad) * Math.cos(lat2 * rad);
  const x =
    Math.cos(lat1 * rad) * Math.sin(lat2 * rad) -
    Math.sin(lat1 * rad) * Math.cos(lat2 * rad) *
    Math.cos((lng2 - lng1) * rad);
  const brng = Math.atan2(y, x);
  return (brng * 180 / Math.PI + 360) % 360;
}
</script>

<!-- ★ YOUR_API_KEY をあなたの安全なキーに置き換えてください -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async></script>

</body>
</html>
