<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>方位オフセット測定（現在地→発電所）</title>

<style>
body { font-family: sans-serif; padding: 20px; }
button, select {
  padding: 12px; font-size: 18px; width: 100%;
  margin-top: 15px; border-radius: 8px;
}
#log { margin-top: 20px; padding: 12px; background: #f0f0f0; border-radius: 8px; }
</style>
</head>

<body>

<h2>スマホの方位オフセット測定</h2>

<p>A＝現在地<br>B＝選択した発電所</p>

<select id="selector">
  <option value="gushikawa">具志川火力発電所</option>
  <option value="kin">金武火力発電所</option>
</select>

<button id="btn">測定開始</button>

<div id="log">待機中…</div>

<script>
const toRad = d => d * Math.PI/180;
const toDeg = r => r * 180/Math.PI;
const wrap360 = x => ((x % 360) + 360) % 360;

// B地点の座標
const PLANTS = {
  gushikawa: { lat: 26.33585, lng: 127.88247 }, // 具志川火力発電所
  kin:       { lat: 26.46375, lng: 127.92470 }  // 金武火力発電所
};

// 地図方位（真方位）
function mapBearing(lat1, lon1, lat2, lon2) {
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return wrap360(toDeg(Math.atan2(y, x)));
}

// 円平均
function circularMean(arr) {
  let sx = 0, sy = 0;
  arr.forEach(d => {
    const r = toRad(d);
    sx += Math.cos(r);
    sy += Math.sin(r);
  });
  return wrap360(toDeg(Math.atan2(sy, sx)));
}

// デバイス方位を12回測定
function measureHeading(count = 12, timeout = 2500) {
  return new Promise(resolve => {
    let list = [];
    const start = Date.now();

    function handler(e) {
      let h;
      if (e.webkitCompassHeading != null) {
        h = wrap360(e.webkitCompassHeading);
      } else if (e.alpha != null) {
        h = wrap360(360 - e.alpha);
      } else return;

      list.push(h);

      if (list.length >= count || Date.now() - start > timeout) {
        window.removeEventListener("deviceorientation", handler);
        resolve(circularMean(list));
      }
    }

    window.addEventListener("deviceorientation", handler);
  });
}

async function run() {
  const log = document.getElementById("log");
  log.innerHTML = "現在地を取得中…";

  navigator.geolocation.getCurrentPosition(async pos => {
    const A = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };

    const key = document.getElementById("selector").value;
    const B = PLANTS[key];

    const mb = mapBearing(A.lat, A.lng, B.lat, B.lng);

    log.innerHTML =
      `A 現在地：${A.lat.toFixed(5)}, ${A.lng.toFixed(5)}<br>` +
      `B：${(key === "gushikawa") ? "具志川火力" : "金武火力"}<br>` +
      `地図方位：${mb.toFixed(1)}°<br><br>` +
      `スマホを静止… 測定中…`;

    // スマホ方位
    const device = await measureHeading();
    const offset = wrap360(mb - device);

    log.innerHTML =
      `✔ 地図方位：${mb.toFixed(1)}°<br>` +
      `✔ スマホ方位：${device.toFixed(1)}°<br><br>` +
      `<b>◆ オフセット：${offset.toFixed(1)}°</b><br><br>` +
      `この値を足せば、スマホの誤差を補正できます。`;
  },
  err => { log.innerHTML = "位置情報が取得できません"; });
}

document.getElementById("btn").onclick = run;
</script>

</body>
</html>
