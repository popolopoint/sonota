<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>方位オフセット測定（完結版）</title>

<style>
body { font-family: sans-serif; padding: 20px; }
button {
  padding: 12px 16px; margin: 10px 0; width: 100%;
  font-size: 18px; border-radius: 8px;
}
#log { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 8px; }
</style>
</head>

<body>

<h2>スマホ方位と地図方位の誤差（オフセット）測定</h2>

<p>① A→B の地図方位を計算し、② スマホの向きを計測し、③ 差（オフセット）を表示します。</p>

<button id="btn">測定開始</button>

<div id="log">待機中…</div>

<script>
// -------------------------------------
// １．ヘルパー
// -------------------------------------

const toRad = d => d * Math.PI/180;
const toDeg = r => r * 180/Math.PI;
const wrap360 = a => ((a % 360) + 360) % 360;

// A→B の緯度・経度（自由に変更OK）
const A = {lat: 26.3520, lng: 127.8670};
const B = {lat: 26.3540, lng: 127.8710};

// 地図方位（真方位）
function mapBearing(lat1, lon1, lat2, lon2) {
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return wrap360(toDeg(Math.atan2(y, x)));
}

// 円平均（角度の平均）
function circularMean(degArray) {
  let sx = 0, sy = 0;
  degArray.forEach(d => {
    const r = toRad(d);
    sx += Math.cos(r);
    sy += Math.sin(r);
  });
  return wrap360(toDeg(Math.atan2(sy, sx)));
}

// -------------------------------------
// ２．スマホの向きを一定数サンプリング
// -------------------------------------
function measureHeading(sampleCount = 12, timeout = 2500) {
  return new Promise((resolve, reject) => {
    let samples = [];
    const start = Date.now();

    function handler(ev) {
      let heading;

      // iOS Safari → webkitCompassHeading
      if (ev.webkitCompassHeading != null) {
        heading = wrap360(ev.webkitCompassHeading);
      } else if (ev.alpha != null) {
        // 多くのAndroid端末
        heading = wrap360(360 - ev.alpha);
      } else {
        return; // 試行不可
      }

      samples.push(heading);

      if (samples.length >= sampleCount ||
          Date.now() - start > timeout) {
        window.removeEventListener("deviceorientation", handler);
        resolve(circularMean(samples));
      }
    }

    window.addEventListener("deviceorientation", handler);
  });
}

// -------------------------------------
// ３．全体フロー
// -------------------------------------
async function run() {
  const log = document.getElementById("log");
  log.innerHTML = "地図方位の計算中…";

  const mb = mapBearing(A.lat, A.lng, B.lat, B.lng);

  log.innerHTML = `
    地図方位(A→B)：${mb.toFixed(1)}°<br>
    スマホを水平にして静止してください…<br>
    方位測定中…
  `;

  try {
    const device = await measureHeading();
    const offset = wrap360(mb - device);

    log.innerHTML = `
      ✔ 地図方位(A→B)：${mb.toFixed(1)}°<br>
      ✔ デバイス方位：${device.toFixed(1)}°<br><br>

      <b>◆ オフセット（補正量）：${offset.toFixed(1)}°</b><br><br>
      ※この値を毎回使えば、スマホの方位誤差を補正できます。
    `;
  } catch (e) {
    log.innerHTML = "測定失敗：" + e;
  }
}

// -------------------------------------
// ボタン
// -------------------------------------
document.getElementById("btn").onclick = run;

</script>

</body>
</html>
