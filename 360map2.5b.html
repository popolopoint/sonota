<!DOCTYPE html>
<html>
<head>
    <title>360map2.5b - ボタンで現在地を取得</title>
    <style>
        /* 地図コンテナのスタイル */
        #map {
            height: 90vh; 
            width: 100%;
        }
        /* 結果表示エリアのスタイル */
        #result {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e9f5ff;
            border-radius: 5px;
        }
        #result h3 {
            color: #007bff;
        }
        .loading, .initial-prompt {
            color: gray;
        }
        #setLocationButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745; /* 緑色 */
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>現在地から具志川火力発電所までの方位</h1>
    
    <button id="setLocationButton">現在位置をA点に設定して計算開始</button>

    <div id="result">
        <p class="initial-prompt">ボタンを押すと現在位置（A点）が特定され、具志川火力発電所（B点）までの方位が計算されます。</p>
    </div>
    <div id="map"></div>

    <script>
        // Google Maps APIキーを設定
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        // 目的地（B点）の固定座標: 具志川火力発電所
        const DESTINATION_B = { 
            lat: 26.3803176, 
            lng: 127.8751869, 
            name: "具志川火力発電所 (B点)"
        };
        
        let map;

        /**
         * マップを初期化する
         */
        function initMap() {
            // 地図の初期表示はB点（具志川火力発電所）を中心に設定
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: DESTINATION_B,
            });

            // ★★★ 変更点 2: B点マーカーを最初から配置 ★★★
             new google.maps.Marker({
                position: DESTINATION_B,
                map: map,
                title: DESTINATION_B.name,
                label: 'B',
            });
            
            // ★★★ 変更点 3: ボタンイベントリスナーの設定 ★★★
            document.getElementById('setLocationButton').addEventListener('click', function() {
                document.getElementById('result').innerHTML = '<p class="loading">現在地を検出中です...</p>';
                findCurrentLocation();
            });
        }
        
        /**
         * ブラウザのGeolocation APIを使用して現在地を取得する
         */
        function findCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentLat = position.coords.latitude;
                        const currentLng = position.coords.longitude;
                        const originA = { lat: currentLat, lng: currentLng, name: "現在位置 (A点)" };
                        
                        // 現在地が取得できたら計算と表示を実行
                        calculateAndDisplay(originA);
                        document.getElementById('setLocationButton').disabled = true; // 計算後はボタンを無効化
                    },
                    (error) => {
                        handleLocationError(true, map.getCenter());
                        console.error("Geolocation failed:", error);
                    }
                );
            } else {
                handleLocationError(false, map.getCenter());
            }
        }

        /**
         * 2点間の球面上の初期方位（Bearing）を計算する
         */
        function calculateBearing(startLat, startLng, endLat, endLng) {
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            let bearingRad = Math.atan2(y, x);
            let bearingDeg = bearingRad * (180 / Math.PI);

            return (bearingDeg + 360) % 360;
        }


        /**
         * 方位を計算し、マーカーと結果エリアに表示する
         * @param {Object} originA - 現在地の座標 {lat, lng, name}
         */
        function calculateAndDisplay(originA) {
            
            const startPoint = new google.maps.LatLng(originA.lat, originA.lng); // A点
            const endPoint = new google.maps.LatLng(DESTINATION_B.lat, DESTINATION_B.lng);   // B点

            const bearing = calculateBearing(
                originA.lat, originA.lng,
                DESTINATION_B.lat, DESTINATION_B.lng
            );

            // 1. A点マーカー (現在地) を設置
            new google.maps.Marker({
                position: startPoint,
                map: map,
                title: originA.name,
                label: 'A',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#007bff',
                    fillOpacity: 1,
                    strokeWeight: 0,
                }
            });

            // 2. A点からB点へ線を引く
            new google.maps.Polyline({
                path: [startPoint, endPoint],
                geodesic: true, 
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map,
            });

            // 3. マップの中心をA点とB点の間に調整
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(startPoint);
            bounds.extend(endPoint);
            map.fitBounds(bounds);


            // 4. 結果を整形して表示
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>✅ 方位計算完了</h3>
                <p><strong>A点</strong> (現在位置): ${originA.lat.toFixed(4)}, ${originA.lng.toFixed(4)}</p>
                <p><strong>B点</strong> (具志川火力発電所): ${DESTINATION_B.lat.toFixed(4)}, ${DESTINATION_B.lng.toFixed(4)}</p>
                <p>
                    <strong>A点から見たB点の方位 (Bearing): 
                    <span style="font-size: 1.5em; color: #FF0000;">${bearing.toFixed(2)}°</span>
                    </strong>
                </p>
                <p>（北を0°として時計回りの角度）</p>
            `;
        }
        
        /**
         * 位置情報の取得に失敗した場合の処理
         */
        function handleLocationError(browserHasGeolocation, pos) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>❌ 現在位置の取得に失敗</h3>
                <p style="color: red;">${browserHasGeolocation ? 
                    'エラーが発生しました。位置情報へのアクセスが拒否されたか、タイムアウトしました。' : 
                    'お使いのブラウザは位置情報APIをサポートしていません。'
                }</p>
            `;
            document.getElementById('setLocationButton').disabled = false;
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>