<!DOCTYPE html>
<html>
<head>
    <title>360map2.5d - 自由なB点選択機能</title>
    <style>
        /* 地図コンテナのスタイル */
        #map {
            height: 90vh;
            width: 100%;
        }
        /* 結果表示エリアのスタイル */
        #result {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e9f5ff;
            border-radius: 5px;
        }
        #result h3 {
            color: #007bff;
        }
        .loading, .initial-prompt {
            color: gray;
        }
        #setLocationButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745; /* 緑色 */
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        #bPointSelection {
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 8px;
            display: inline-block;
            border-radius: 5px;
            background-color: #fff;
        }
        #bTapInstruction {
            font-weight: bold;
            color: red;
            display: none;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>現在地と目的地の方位計算</h1>

    <button id="setLocationButton">現在位置をA点に設定</button>
    
    <div id="bPointSelection">
        <strong>B点 (目的地) の選択:</strong>
        <label><input type="radio" name="b_option" value="gushikawa" checked> 具志川火力発電所</label>
        <label><input type="radio" name="b_option" value="kinjo"> 金武火力発電所</label>
        <label><input type="radio" name="b_option" value="tap"> 地図上でタップ</label>
    </div>
    <p id="bTapInstruction">**地図をタップしてB点を設定してください**</p>

    <div id="result">
        <p class="initial-prompt">まず「現在位置をA点に設定」ボタンを押し、その後B点をラジオボタンで選択または地図上でタップしてください。</p>
    </div>
    <div id="map"></div>

    <script>
        // Google Maps APIキーを設定
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        // 目的地（B点）の固定座標リスト
        const B_POINTS = {
            gushikawa: { lat: 26.3803176, lng: 127.8751869, name: "具志川火力発電所 (B点)" },
            kinjo: { lat: 26.4454055, lng: 127.9209787, name: "金武火力発電所 (B点)" }
        };
        
        let map;
        let currentOriginA = null;      // A点の座標 (LatLngオブジェクト)
        let currentDestinationB = null; // B点の座標 (LatLngオブジェクト)
        let mapTapMode = false;         // マップタップでB点を設定するモードか
        
        let markerA = null;
        let markerB = null;
        let polyline = null;


        /**
         * マップを初期化する
         */
        function initMap() {
            // 初期表示は具志川火力発電所を中心に
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: B_POINTS.gushikawa,
            });

            // 1. A点設定ボタンのイベントリスナー
            document.getElementById('setLocationButton').addEventListener('click', function() {
                document.getElementById('result').innerHTML = '<p class="loading">現在地を検出中です...</p>';
                findCurrentLocation();
            });

            // 2. B点選択ラジオボタンのイベントリスナー
            const radioButtons = document.getElementsByName('b_option');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', handleBSelectionChange);
            });
            
            // 3. マップクリックイベントリスナー (B点タップモード用)
            map.addListener('click', handleMapClick);

            // 初期B点を設定 (デフォルトは具志川)
            setDestinationB(B_POINTS.gushikawa);
        }
        
        /**
         * B点選択ラジオボタンが変更されたときの処理
         */
        function handleBSelectionChange(event) {
            const selectedValue = event.target.value;
            
            // タップモードの説明表示をリセット
            document.getElementById('bTapInstruction').style.display = 'none';
            mapTapMode = false;
            
            if (selectedValue === 'tap') {
                // 地図タップモードを有効化
                document.getElementById('bTapInstruction').style.display = 'block';
                currentDestinationB = null; // B点をクリア
                mapTapMode = true;
            } else {
                // 固定座標を設定
                setDestinationB(B_POINTS[selectedValue]);
            }
            
            // A点が設定されていれば計算を試みる
            if (currentOriginA) {
                calculateAndDisplay();
            }
        }
        
        /**
         * マップがクリックされたときの処理
         */
        function handleMapClick(event) {
            if (mapTapMode) {
                // タップモードが有効な場合、クリック位置をB点とする
                setDestinationB({
                    lat: event.latLng.lat(), 
                    lng: event.latLng.lng(), 
                    name: "マップタップ位置 (B点)"
                });
                
                // タップモードを終了
                mapTapMode = false;
                document.getElementById('bTapInstruction').style.display = 'none';

                // ラジオボタンの選択を「地図上でタップ」状態に強制する（UIと状態を一致させる）
                document.querySelector('input[name="b_option"][value="tap"]').checked = true;

                // A点が設定されていれば計算を試みる
                if (currentOriginA) {
                    calculateAndDisplay();
                }
            }
        }
        
        /**
         * B点マーカーを設定し、計算を試みる
         */
        function setDestinationB(coords) {
            currentDestinationB = new google.maps.LatLng(coords.lat, coords.lng);
            
            // B点マーカーを更新または新規作成
            if (markerB) {
                markerB.setPosition(currentDestinationB);
                markerB.setTitle(coords.name);
            } else {
                markerB = new google.maps.Marker({
                    position: currentDestinationB,
                    map: map,
                    title: coords.name,
                    label: 'B',
                });
            }
            
            // A点が設定されていれば、すぐに計算を行う
            if (currentOriginA) {
                calculateAndDisplay();
            } else {
                // A点が未設定の場合は、地図の中心をB点に移動
                map.setCenter(currentDestinationB);
            }
        }
        

        /**
         * ブラウザのGeolocation APIを使用して現在地を取得する (A点設定)
         */
        function findCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentLat = position.coords.latitude;
                        const currentLng = position.coords.longitude;
                        currentOriginA = new google.maps.LatLng(currentLat, currentLng);
                        
                        // A点マーカーを更新または新規作成
                        if (markerA) {
                            markerA.setPosition(currentOriginA);
                        } else {
                            markerA = new google.maps.Marker({
                                position: currentOriginA,
                                map: map,
                                title: "現在位置 (A点)",
                                label: 'A',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#007bff',
                                    fillOpacity: 1,
                                    strokeWeight: 0,
                                }
                            });
                        }
                        
                        // B点が設定されていれば計算と表示を実行
                        calculateAndDisplay();
                        
                        document.getElementById('setLocationButton').textContent = '現在位置をA点に設定 (更新)';
                    },
                    (error) => {
                        handleLocationError(true);
                        console.error("Geolocation failed:", error);
                    }
                );
            } else {
                handleLocationError(false);
            }
        }

        /**
         * 2点間の球面上の初期方位（Bearing）を計算する
         */
        function calculateBearing(startLat, startLng, endLat, endLng) {
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            let bearingRad = Math.atan2(y, x);
            let bearingDeg = bearingRad * (180 / Math.PI);

            return (bearingDeg + 360) % 360;
        }


        /**
         * A点とB点が揃っている場合に、方位を計算し、マーカーと結果エリアに表示する
         */
        function calculateAndDisplay() {
            if (!currentOriginA || !currentDestinationB) {
                document.getElementById('result').innerHTML = `
                    <h3>待機中...</h3>
                    <p>A点: ${currentOriginA ? '設定済み' : '未設定'}</p>
                    <p>B点: ${currentDestinationB ? '設定済み' : '未設定'}</p>
                `;
                return;
            }
            
            const startLat = currentOriginA.lat();
            const startLng = currentOriginA.lng();
            const endLat = currentDestinationB.lat();
            const endLng = currentDestinationB.lng();

            const bearing = calculateBearing(startLat, startLng, endLat, endLng);

            // 線の再描画
            if (polyline) {
                polyline.setMap(null);
            }
            polyline = new google.maps.Polyline({
                path: [currentOriginA, currentDestinationB],
                geodesic: true, 
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map,
            });

            // 地図の表示範囲を調整
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(currentOriginA);
            bounds.extend(currentDestinationB);
            map.fitBounds(bounds);


            // 結果を整形して表示
            const resultDiv = document.getElementById('result');
            
            // B点の名称を取得 (固定の場合はB_POINTSから逆引き、タップの場合はマーカーのタイトル)
            let bName = markerB ? markerB.getTitle() : 'タップ位置';

            resultDiv.innerHTML = `
                <h3>✅ 方位計算完了</h3>
                <p><strong>A点</strong> (現在位置): ${startLat.toFixed(4)}, ${startLng.toFixed(4)}</p>
                <p><strong>B点</strong> (${bName}): ${endLat.toFixed(4)}, ${endLng.toFixed(4)}</p>
                <p>
                    <strong>A点から見たB点の方位 (Bearing): 
                    <span style="font-size: 1.5em; color: #FF0000;">${bearing.toFixed(2)}°</span>
                    </strong>
                </p>
                <p>（北を0°として時計回りの角度）</p>
            `;
        }
        
        /**
         * 位置情報の取得に失敗した場合の処理
         */
        function handleLocationError(browserHasGeolocation) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>❌ 現在位置の取得に失敗 (A点未設定)</h3>
                <p style="color: red;">${browserHasGeolocation ? 
                    'エラーが発生しました。位置情報へのアクセスが拒否されたか、タイムアウトしました。' : 
                    'お使いのブラウザは位置情報APIをサポートしていません。'
                }</p>
            `;
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>