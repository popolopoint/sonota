<!DOCTYPE html>
<html>
<head>
    <title>360map2.5h - ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®è¡¨ç¤º</title>
    <style>
        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 70vh;
            width: 100%;
        }
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #result {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e9f5ff;
            border-radius: 5px;
        }
        #result h3 {
            color: #007bff;
        }
        /* ã‚»ãƒ³ã‚µãƒ¼çª“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #compassWindow {
            padding: 15px;
            margin-top: 10px;
            border: 2px solid #5cb85c;
            background-color: #f0fff0;
            border-radius: 5px;
            text-align: center;
        }
        #compassWindow strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #5cb85c;
        }
        #headingRealtime {
            font-size: 2.5em;
            color: #4CAF50; 
            font-weight: bold;
        }
        #headingCaptured {
            font-size: 1.5em;
            color: #d9534f; /* è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ (èµ¤) */
            font-weight: bold;
        }
        #trueBearingDisplay {
            font-size: 1.5em;
            color: #337ab7; /* åœ°ç†çš„ãªæ–¹ä½ (é’) */
            font-weight: bold;
        }
        #errorDisplay { /* â˜…â˜…â˜… èª¤å·®è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
            font-size: 1.8em;
            color: #FF6347; /* ç›®ç«‹ã¤è‰² */
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 0;
            border-top: 1px dashed #ccc;
        }
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #setLocationButton, #captureHeadingButton, #startCompassButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        #setLocationButton { background-color: #28a745; color: white; }
        #startCompassButton { background-color: #ffc107; color: black; }
        #captureHeadingButton { background-color: #d9534f; color: white; }
    </style>
</head>
<body>
    <h1>ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®è¡¨ç¤ºæ©Ÿèƒ½ (360map2.5h)</h1>

    <button id="setLocationButton">ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š</button>
    
    <div id="bPointSelection">
        <strong>Bç‚¹ (ç›®çš„åœ°) ã®é¸æŠ:</strong>
        <label><input type="radio" name="b_option" value="gushikawa" checked> å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="kinjo"> é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="tap"> åœ°å›³ä¸Šã§ã‚¿ãƒƒãƒ—</label>
    </div>
    <p id="bTapInstruction" style="display:none; color: red; font-weight: bold;">**åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„**</p>

    <div id="result">
        <p class="initial-prompt">Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šã™ã‚‹ã¨ã€**Aã‹ã‚‰è¦‹ãŸBã®çœŸã®æ–¹ä½**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <button id="startCompassButton">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹</button>
    <button id="captureHeadingButton" disabled>Bç‚¹ã«ã‚¹ãƒãƒ›ã‚’å‘ã‘ã¦æ–¹ä½ã‚’æ±ºå®š</button>

    <div id="compassWindow">
        <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–¹ä½ (åŒ—=0Â°)</strong>
        <p id="headingRealtime">--</p>
        <strong>è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ (æ±ºå®šå€¤)</strong>
        <p id="headingCaptured">è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
        <p style="font-size: 0.9em;" id="compassStatus">ã‚»ãƒ³ã‚µãƒ¼ã¯åœæ­¢ä¸­ã§ã™ã€‚</p>
    </div>

    <div id="map"></div>

    <script>
        // Google Maps APIã‚­ãƒ¼ã‚’è¨­å®š
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        const B_POINTS = {
            gushikawa: { lat: 26.3803176, lng: 127.8751869, name: "å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" },
            kinjo: { lat: 26.4454055, lng: 127.9209787, name: "é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" }
        };
        
        let map;
        let currentOriginA = null;
        let currentDestinationB = null;
        let mapTapMode = false;
        
        let markerA = null;
        let markerB = null;
        let polyline = null;

        let lastReadHeading = null; 
        let isCompassRunning = false; 

        // --- ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ã®é–¢æ•° (æ–¹ä½è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£) ---
        
        function toggleCompass() {
            // ... (å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜) ...
            const statusDiv = document.getElementById('compassStatus');
            const startButton = document.getElementById('startCompassButton');
            const captureButton = document.getElementById('captureHeadingButton');

            if (isCompassRunning) {
                window.removeEventListener('deviceorientation', handleOrientation);
                isCompassRunning = false;
                startButton.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹';
                statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã¯åœæ­¢ä¸­ã§ã™ã€‚';
                captureButton.disabled = true;
                document.getElementById('headingRealtime').textContent = '--';
            } else {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startSensorLogic(startButton, statusDiv, captureButton);
                            } else {
                                statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            }
                        })
                        .catch(console.error);
                } else {
                    startSensorLogic(startButton, statusDiv, captureButton);
                }
            }
        }
        
        function startSensorLogic(startButton, statusDiv, captureButton) {
            window.addEventListener('deviceorientation', handleOrientation);
            isCompassRunning = true;
            startButton.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’åœæ­¢';
            statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ã€‚ã‚¹ãƒãƒ›ã‚’Bç‚¹ã«å‘ã‘ã¦ãã ã•ã„ã€‚';
            captureButton.disabled = false;
        }

        function handleOrientation(event) {
            if (event.alpha === null) return;
            lastReadHeading = (360 - event.alpha + 360) % 360; 
            document.getElementById('headingRealtime').textContent = `${lastReadHeading.toFixed(1)}Â°`;
        }
        
        /**
         * ç¾åœ¨èª­ã¿å–ã£ã¦ã„ã‚‹æ–¹ä½ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€èª¤å·®ã‚’è¨ˆç®—ã—ã¦çµæœçª“ã‚’æ›´æ–°ã™ã‚‹
         */
        function captureHeading() {
            if (lastReadHeading === null) {
                 document.getElementById('result').innerHTML = `<h3>âŒ è¨˜éŒ²å¤±æ•—</h3><p style="color: red;">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ãŒã¾ã å€¤ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚»ãƒ³ã‚µãƒ¼ã‚’èµ·å‹•ã—ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>`;
                 return;
            }

            const capturedValue = lastReadHeading;
            document.getElementById('headingCaptured').textContent = `${capturedValue.toFixed(1)}Â°`;
            
            // Aç‚¹ã¨Bç‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€èª¤å·®è¨ˆç®—ã¨è©³ç´°è¡¨ç¤ºã‚’è¡Œã†
            if (currentOriginA && currentDestinationB) {
                
                const startLat = currentOriginA.lat();
                const startLng = currentOriginA.lng();
                const endLat = currentDestinationB.lat();
                const endLng = currentDestinationB.lng();
                const trueBearing = calculateBearing(startLat, startLng, endLat, endLng);
                
                // èª¤å·®ã‚’è¨ˆç®—: è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ - çœŸã®æ–¹ä½
                let error = capturedValue - trueBearing;
                
                // èª¤å·®ã‚’ -180Â° ã‹ã‚‰ +180Â° ã®ç¯„å›²ã«æ­£è¦åŒ–
                if (error > 180) {
                    error -= 360;
                } else if (error < -180) {
                    error += 360;
                }

                // çµæœè¡¨ç¤ºã®æ›´æ–°
                let bName = markerB ? markerB.getTitle() : 'ã‚¿ãƒƒãƒ—ä½ç½®';

                document.getElementById('result').innerHTML = `
                    <h3>âœ… æ–¹ä½è¨˜éŒ²ã¨èª¤å·®è¨ˆç®—å®Œäº†</h3>
                    
                    <p><strong>Aç‚¹ã‹ã‚‰è¦‹ãŸBç‚¹ã®æ–¹ä½ (çœŸã®æ–¹ä½):</strong> 
                    <span id="trueBearingDisplay">${trueBearing.toFixed(2)}Â°</span>
                    <span style="color: #337ab7; font-weight: bold;">(åœ°ç†çš„ãªè§’åº¦)</span></p>

                    <p><strong>è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ (æ±ºå®šå€¤):</strong> 
                    <span style="color:#d9534f">${capturedValue.toFixed(2)}Â°</span>
                    <span style="color: #d9534f; font-weight: bold;">(ã‚»ãƒ³ã‚µãƒ¼è¨˜éŒ²ã®è§’åº¦)</span></p>

                    <p id="errorDisplay">
                        ğŸ§­ ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®: ${error.toFixed(2)}Â°
                    </p>
                    <p style="font-size: 0.9em;">
                        ï¼ˆèª¤å·® = è¨˜éŒ²å€¤ ${capturedValue.toFixed(1)}Â° âˆ’ çœŸæ–¹ä½ ${trueBearing.toFixed(1)}Â°ï¼‰
                    </p>
                    <p>Aç‚¹: ${startLat.toFixed(4)}, Bç‚¹ (${bName}): ${endLat.toFixed(4)}</p>
                `;

            } else {
                 document.getElementById('result').innerHTML = `
                    <h3>âœ… æ–¹ä½è¨˜éŒ²å®Œäº† (èª¤å·®è¨ˆç®—ä¸å¯)</h3>
                    <p>è¨˜éŒ²å€¤: <span style="font-size: 1.5em; color:#d9534f">${capturedValue.toFixed(1)}Â°</span></p>
                    <p>åœ°ç†çš„ãª**ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®ã‚’è¨ˆç®—**ã™ã‚‹ã«ã¯ã€Aç‚¹ã¨Bç‚¹ã®ä¸¡æ–¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                `;
            }
        }

        // --- åœ°ç†çš„ãªæ–¹ä½è¨ˆç®— (çƒé¢å¹¾ä½•å­¦) ---
        
        function calculateBearing(startLat, startLng, endLat, endLng) {
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            let bearingRad = Math.atan2(y, x);
            let bearingDeg = bearingRad * (180 / Math.PI);

            return (bearingDeg + 360) % 360;
        }

        // --- ãƒãƒƒãƒ—æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ (å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜) ---
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: B_POINTS.gushikawa,
            });

            document.getElementById('setLocationButton').addEventListener('click', findCurrentLocation);
            document.getElementById('startCompassButton').addEventListener('click', toggleCompass);
            document.getElementById('captureHeadingButton').addEventListener('click', captureHeading); 
            
            document.getElementsByName('b_option').forEach(radio => {
                radio.addEventListener('change', handleBSelectionChange);
            });
            map.addListener('click', handleMapClick);

            setDestinationB(B_POINTS.gushikawa);
        }

        function handleBSelectionChange(event) {
            const selectedValue = event.target.value;
            document.getElementById('bTapInstruction').style.display = 'none';
            mapTapMode = false;
            
            if (selectedValue === 'tap') {
                document.getElementById('bTapInstruction').style.display = 'block';
                currentDestinationB = null;
                mapTapMode = true;
            } else {
                setDestinationB(B_POINTS[selectedValue]);
            }
            if (currentOriginA) { displayCalculatedBearing(); }
        }
        
        function handleMapClick(event) {
            if (mapTapMode) {
                setDestinationB({
                    lat: event.latLng.lat(), 
                    lng: event.latLng.lng(), 
                    name: "ãƒãƒƒãƒ—ã‚¿ãƒƒãƒ—ä½ç½® (Bç‚¹)"
                });
                
                mapTapMode = false;
                document.getElementById('bTapInstruction').style.display = 'none';
                document.querySelector('input[name="b_option"][value="tap"]').checked = true;
                
                if (currentOriginA) { displayCalculatedBearing(); }
            }
        }
        
        function setDestinationB(coords) {
            currentDestinationB = new google.maps.LatLng(coords.lat, coords.lng);
            
            if (markerB) {
                markerB.setPosition(currentDestinationB);
                markerB.setTitle(coords.name);
            } else {
                markerB = new google.maps.Marker({
                    position: currentDestinationB,
                    map: map,
                    title: coords.name,
                    label: 'B',
                });
            }
            if (currentOriginA) { updateMapDisplay(); } else { map.setCenter(currentDestinationB); }
        }
        

        function findCurrentLocation() {
            document.getElementById('result').innerHTML = '<p class="loading">ç¾åœ¨åœ°ã‚’æ¤œå‡ºä¸­ã§ã™...</p>';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentOriginA = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        
                        if (markerA) { markerA.setPosition(currentOriginA); } 
                        else {
                            markerA = new google.maps.Marker({
                                position: currentOriginA, map: map, title: "ç¾åœ¨ä½ç½® (Aç‚¹)", label: 'A',
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#007bff', fillOpacity: 1, strokeWeight: 0, }
                            });
                        }
                        
                        updateMapDisplay();
                        document.getElementById('setLocationButton').textContent = 'ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š (æ›´æ–°)';
                        document.getElementById('result').innerHTML = `<h3>âœ… Aç‚¹è¨­å®šå®Œäº†</h3><p>ç¾åœ¨ä½ç½®ãŒAç‚¹ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã—ãŸã€‚</p>`;
                        displayCalculatedBearing(); 

                    },
                    (error) => {
                        document.getElementById('result').innerHTML = `<h3>âŒ Aç‚¹è¨­å®šå¤±æ•—</h3><p style="color: red;">ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ã€‚</p>`;
                    }
                );
            } else {
                document.getElementById('result').innerHTML = `<h3>âŒ Aç‚¹è¨­å®šå¤±æ•—</h3><p style="color: red;">ãƒ–ãƒ©ã‚¦ã‚¶ãŒä½ç½®æƒ…å ±APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</p>`;
            }
        }
        
        function updateMapDisplay() {
            if (!currentOriginA || !currentDestinationB) { return; }

            if (polyline) { polyline.setMap(null); }
            polyline = new google.maps.Polyline({
                path: [currentOriginA, currentDestinationB], geodesic: true, strokeColor: '#FF0000',
                strokeOpacity: 1.0, strokeWeight: 2, map: map,
            });

            const bounds = new google.maps.LatLngBounds();
            bounds.extend(currentOriginA);
            bounds.extend(currentDestinationB);
            map.fitBounds(bounds);
        }

        /**
         * Aç‚¹ã¨Bç‚¹é–“ã®åœ°ç†çš„ãªæ–¹ä½ã‚’è¨ˆç®—ã—ã€çµæœã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«è¡¨ç¤ºã™ã‚‹ (èª¤å·®è¨ˆç®—ã¯å«ã¾ãªã„)
         */
        function displayCalculatedBearing() {
            if (!currentOriginA || !currentDestinationB) {
                document.getElementById('result').innerHTML = `<h3>å¾…æ©Ÿä¸­...</h3><p>Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>`;
                return;
            }
            
            const startLat = currentOriginA.lat();
            const startLng = currentOriginA.lng();
            const endLat = currentDestinationB.lat();
            const endLng = currentDestinationB.lng();

            const trueBearing = calculateBearing(startLat, startLng, endLat, endLng);
            
            let bName = markerB ? markerB.getTitle() : 'ã‚¿ãƒƒãƒ—ä½ç½®';

            // è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ãŒã¾ã ãªã„å ´åˆã¯ã€èª¤å·®ãªã—ã®åŸºæœ¬è¡¨ç¤ºã‚’è¡Œã†
            document.getElementById('result').innerHTML = `
                <h3>âœ… æ–¹ä½è¨ˆç®—çµæœ</h3>
                <p><strong>Aç‚¹ã‹ã‚‰è¦‹ãŸBç‚¹ã®æ–¹ä½ (çœŸã®æ–¹ä½):</strong> 
                <span id="trueBearingDisplay">${trueBearing.toFixed(2)}Â°</span>
                <span style="color: #337ab7; font-weight: bold;">(åœ°ç†çš„ãªè§’åº¦)</span></p>
                <p>Aç‚¹: ${startLat.toFixed(4)}, Bç‚¹ (${bName}): ${endLat.toFixed(4)}</p>
                <p style="font-size: 0.9em;">**ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®ã‚’è¨ˆç®—**ã™ã‚‹ã«ã¯ã€ã€Œæ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹ã€å¾Œã«ã‚¹ãƒãƒ›ã‚’Bç‚¹ã«å‘ã‘ã€ã€Œæ–¹ä½ã‚’æ±ºå®šã€ã—ã¦ãã ã•ã„ã€‚</p>
            `;
        }

    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>